---
description: Expo Router navigation patterns and auth flow
globs: app/**/*.tsx
alwaysApply: false
---

# Navigation Conventions

- Use `router.replace()` for auth redirects and when navigation history may be empty
- Use `router.push()` for normal navigation within a flow
- Use `router.back()` only when certain there's navigation history
- Auth flow handled in `app/_layout.tsx` via `AuthGate` component
- Onboarding uses `router.replace()` for back navigation to avoid errors when history is empty
- Onboarding step saved to database (`onboardingStep` field) for resume on app restart
- Onboarding supports **editing mode** (`editing=true` param): entered from Settings > Edit Profile, shows X button to close, skips `setOnboardingStep`, carries `editing` param via `goToNextStep(router, step, isEditing)`

## App Navigation Flow

```
Landing (/) -> Auth -> Onboarding -> (tabs)
```

### AuthGate Routing Logic (`app/_layout.tsx`)

1. Not signed in -> `/` (landing page)
2. Signed in, onboarding incomplete -> `/(onboarding)/<step>`
3. Signed in, onboarding complete, voice questions incomplete -> `/(tabs)/questions`
4. Signed in, voice complete + profile parsed, audit NOT completed -> `/profile-audit?firstTime=true`
5. Signed in, onboarding complete, voice questions complete, audit complete -> `/(tabs)/matches`

AuthGate queries `voiceRecordings.getCompletedCount` and `userProfiles.hasProfile` to determine completion. The `profile_audit` route state forces users through profile review before they can reach matches. `hasRouted` state resets when `effectiveIsSignedIn` changes to handle sign-out/sign-in cycles. `onLandingPage` check includes `segments[0] === "index"` for proper root detection.

### Dynamic Tab Bar (`app/(tabs)/_layout.tsx`)

Tabs are shown/hidden based on voice question completion state:

- **Before questions complete**: Questions tab + Settings tab (2 tabs)
- **After questions complete**: Matches + Chats + Settings (3 tabs)

Tab bar: black background, white active icons, icon-only (no labels), `lazy: false` (eager-loads all screens). Each screen has a 150ms fade-in animation on data ready. Tab bar itself slides up + fades in on mount.

### Settings Tab (`app/(tabs)/settings.tsx`)

Always visible. Contains profile photo, name editing, notifications, sign-out. "My Profile" and "Edit Answers" links are conditionally hidden until voice questions are complete. "My Profile" navigates to `/profile-audit` (casual edit mode). "Edit Answers" navigates to `/edit-answers` which renders `QuestionsScreenContent` with `forceEditing`.

### Sign Out

Settings calls `signOut()` without manual navigation -- AuthGate handles redirect to landing page automatically when `effectiveIsSignedIn` flips.

## Dev Admin Panel (DEV MODE ONLY)

- Long-press center-top of any screen for 3 seconds to open
- `components/DevTrigger.tsx` + `components/DevAdminPanel.tsx`
- Supports user search and fresh test user creation
- Dev impersonation is **read-only**: `devClerkId` in `stores/offline.ts` swaps which user the UI displays, but Convex mutations always act as the real authenticated user (identity comes from the JWT)
- `hooks/useEffectiveUserId.ts`: returns `devClerkId` when impersonating (for query gating), otherwise real Clerk userId
