---
description: Voice questions system for onboarding
globs: "**/voice*", convex/voiceRecordings.ts
alwaysApply: false
---

# Voice Questions System (Primary Onboarding)

Users answer 8 open-ended questions by recording voice memos. AI transcribes and extracts structured profile data.

## 8 Voice Questions (`lib/voice-questions.ts`, `convex/actions/voiceQuestionDefinitions.ts`)

| #   | Category             | Question                                                                                                                  | Captures                                                  |
| --- | -------------------- | ------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------- |
| 1   | Values & Identity    | "Who are you? What do you care about? What gives your life meaning?"                                                      | values, identity, priorities                              |
| 2   | Love & Relationships | "What does your ideal relationship look like? How do you love, and how do you want to be loved?"                          | love language, relationship style, attachment             |
| 3   | Your Story           | "Tell me your story. What experiences shaped who you are today?"                                                          | background, formative moments, life story                 |
| 4   | Daily Life           | "Walk me through your life right now — your days, your work, how you spend your time."                                    | lifestyle, career, daily routine                          |
| 5   | Family & Future      | "What's your relationship with family like, and what do you envision for your own future?"                                | family closeness, kids, future plans                      |
| 6   | What You Want        | "What are you looking for in a partner? What would make someone not right for you?"                                       | partner preferences, dealbreakers                         |
| 7   | Passions             | "What are you passionate about? What could you talk about for hours?"                                                     | interests, hobbies, passions                              |
| 8   | Growth               | "How have you grown in the last few years? What are some things you used to believe that you've changed your mind about?" | growth mindset, self-awareness, evolution                 |

## Technical Architecture

- **Recording**: `expo-av` Audio API, M4A format
- **Storage**: Saved to Convex `_storage` bucket
- **Transcription**: OpenAI Whisper API (`whisper-1`), parallel
- **Extraction**: GPT processes all 8 transcripts together
- **Auto-trigger**: `saveRecording` mutation schedules `parseVoiceProfile` when count reaches 8
- **Re-parsing**: Updating any recording after completion re-triggers full parsing
- **Cost**: ~$0.05-0.10 per user (Whisper + GPT)

## Convex Action (`convex/actions/parseVoiceProfile.ts`)

1. Fetch all 8 recordings -> get audio URLs from storage
2. Transcribe each with Whisper (parallel, reuses existing transcriptions)
3. Save transcriptions to `voiceRecordings` table
4. Extract structured profile via GPT (values, traits, bios, relationship style, etc.)
5. Save to `userProfiles` table
6. **Does NOT schedule compatibility** — compatibility is triggered separately via `completeProfileAudit` after the user reviews their profile on the audit screen
7. **Batch reparse**: `reparseAllProfiles` action finds all users with 8 recordings and schedules reparsing (5s stagger)

## Regeneration Flow

- User triggers via `api.users.regenerateProfile` mutation (rate-limited: 1 hour cooldown via `lastProfileRegeneratedAt`)
- Mutation validates recordings count, sets cooldown timestamp, schedules `parseVoiceProfile`
- Client shows celebration overlay, watches `myProfile.processedAt`, then navigates to mandatory profile-audit
- Audit screen calls `completeProfileAudit` on "Looks Good" which schedules compatibility generation
