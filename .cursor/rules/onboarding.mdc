---
description: Onboarding flow details and screen behavior
globs: app/(onboarding)/**, components/OnboardingScreen.tsx, components/BasicOptionScreen.tsx, components/OptionButton.tsx, components/ImportanceSlider.tsx, hooks/useBasicsStep.ts, lib/onboarding-flow.ts
alwaysApply: false
---

# Onboarding Flow

Defined in `lib/onboarding-flow.ts`. Linear sequence: referral -> name -> pronouns -> gender -> sexuality -> location -> birthday -> age-range -> height -> photos -> relationship-goals -> relationship-type -> kids -> wants-kids -> ethnicity -> hometown -> religion -> politics -> pets -> drinking -> smoking -> marijuana -> drugs.

## Component Architecture

- **`useBasicsStep`** (`hooks/useBasicsStep.ts`): Shared hook for ALL basics screens. Provides `userId`, `currentUser`, `isEditing`, `loading`, `save(data)`, `close()`. Handles editing-mode navigation (router.back), onboarding navigation (goToNextStep + setOnboardingStep), and last-step completion (completeCategory) automatically. Also exports `useSavedValue` helper for loading saved data from the user record.
- **`BasicOptionScreen`** (`components/BasicOptionScreen.tsx`): Config-driven component for option-select screens. Built on `OnboardingScreen` + `useBasicsStep`. Supports `visibilityField` (toggle), `importanceField` (slider), `optionVariant` (chip/row/default). Auto-advances on first selection during initial onboarding (single-question screens only, no prior answer).
- **`OnboardingScreen`** (`components/OnboardingScreen.tsx`): Shared shell for all question pages. Provides question heading (top), footer with Save/Next button (bottom), and optional `onClose` back arrow header (editing mode). Props: `submitLabel` (defaults to "Next"), `onClose` (shows back arrow at top).
- **`OptionButton`** (`components/OptionButton.tsx`): Selectable option. Variants: `default`, `compact`, `pill`, `chip`, `row`.
- **`ImportanceSlider`** (`components/ImportanceSlider.tsx`): "How important is it that your partner aligns with you here?" 1-10 slider. Used by religion and politics.

## Screen Types

**Config-driven (via `BasicOptionScreen`, ~7-10 lines each):**
pronouns, gender, sexuality, relationship-goals, relationship-type, kids, wants-kids, ethnicity, pets, religion, politics, drinking, smoking, marijuana, drugs

**Custom layout (use `useBasicsStep` hook directly):**
name, location, birthday, age-range, height, hometown

**Fully custom:**
photos (own layout, no `useBasicsStep`)

## Layout Header (`_layout.tsx`)

- **Initial onboarding**: Back chevron (left) + centered progress bar (120px) + step counter ("5 of 22")
- **Editing mode / basics-summary**: No layout header. Each screen renders its own back arrow via `onClose` prop.

## Editing Mode

When entering from the Questions tab or basics-summary, screens receive `editing=true` param. In editing mode:
- Screen shows a back arrow at top (via `onClose` on `OnboardingScreen`, or custom `closeHeader` on custom screens)
- Footer shows a single "Save" button (no Back/Next row)
- `save()` calls `router.back()` instead of advancing to next step
- `setOnboardingStep` is skipped (doesn't reset onboarding progress)
- Layout progress bar is hidden

## Basics Summary (`basics-summary.tsx`)

Summary/edit page showing all basics fields organized by section. Each row shows the current value and navigates to the corresponding screen with `editing=true`. Unanswered fields show a red warning icon + "Answer this" text with highlighted row background.

## Three-State Basics Card (`questions.tsx`)

The Basics card on the Questions tab has three states:
- **Complete** (`basicsComplete`): Green check + "Edit" -> basics-summary
- **Has unanswered** (`completedCategories` includes `"the_basics"` but `basicsComplete` is false): Warning triangle + "Update" -> basics-summary (never forces back into linear onboarding)
- **First time** (never completed onboarding): "Answer" button -> first unanswered step in linear flow

## Auto-Advance

During initial onboarding, single-question screens (no visibility toggle, no importance slider) with no prior answer auto-advance instantly on selection. Controlled in `BasicOptionScreen` via `canAutoAdvance`.

## Voice Questions Screen (`voice-questions.tsx`)
- Full-screen recording interface for 8 open-ended questions
- States: idle -> recording (waveform) -> preview
- Haptic feedback on start/stop/save/delete
- Auto-saves recordings to Convex storage
- All 8 complete -> auto-triggers `parseVoiceProfile` action
- Re-recording any question re-triggers full parsing
