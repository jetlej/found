---
description: Onboarding flow details and screen behavior
globs: app/(onboarding)/**, components/OnboardingScreen.tsx, components/BasicOptionScreen.tsx, components/OptionButton.tsx, components/ImportanceSlider.tsx, hooks/useBasicsStep.ts, lib/onboarding-flow.ts
alwaysApply: false
---

# Onboarding Flow

Defined in `lib/onboarding-flow.ts`. Linear sequence: referral -> name -> pronouns -> gender -> sexuality -> location -> birthday -> age-range -> height -> photos -> relationship-goals -> relationship-type -> kids -> wants-kids -> ethnicity -> hometown -> religion -> politics -> pets -> drinking -> smoking -> marijuana -> drugs -> tattoos.

## Component Architecture

- **`useBasicsStep`** (`hooks/useBasicsStep.ts`): Shared hook for ALL basics screens. Provides `userId`, `currentUser`, `isEditing`, `loading`, `save(data)`, `close()`. Handles editing-mode navigation (router.back), onboarding navigation (goToNextStep + setOnboardingStep), and last-step completion (completeCategory) automatically. Also exports `useSavedValue` helper for loading saved data from the user record.
- **`BasicOptionScreen`** (`components/BasicOptionScreen.tsx`): Config-driven component for option-select screens. Built on `OnboardingScreen` + `useBasicsStep`. Supports `visibilityField` (toggle), `importanceField` (slider), `optionVariant` (chip/row/default). Auto-advances on first selection during initial onboarding (single-question screens only, no prior answer).
- **`OnboardingScreen`** (`components/OnboardingScreen.tsx`): Shared shell for all question pages. Provides question heading (top), footer with Save/Next button (bottom), and optional `onClose` back arrow header (editing mode). Props: `submitLabel` (defaults to "Next"), `onClose` (shows back arrow at top).
- **`OptionButton`** (`components/OptionButton.tsx`): Selectable option. Variants: `default`, `compact`, `pill`, `chip`, `row`.
- **`ImportanceSlider`** (`components/ImportanceSlider.tsx`): "How important is it that your partner aligns with you here?" 1-10 slider. Used by religion and politics.

## Screen Types

**Config-driven (via `BasicOptionScreen`, ~7-10 lines each):**
pronouns, gender, sexuality, relationship-goals, relationship-type, kids, wants-kids, ethnicity, pets, religion, politics, drinking, smoking, marijuana, drugs, tattoos

**Custom layout (use `useBasicsStep` hook directly):**
name, location, birthday, age-range, height, hometown

**Fully custom:**
photos (own layout, no `useBasicsStep`)

## Layout Header (`_layout.tsx`)

- **Initial onboarding**: Back chevron (left) + centered progress bar (120px) + step counter ("5 of 22")
- **Editing mode / basics-summary**: No layout header. Each screen renders its own back arrow via `onClose` prop.

## Editing Mode

When entering from the Settings tab (Edit Profile) or basics-summary, screens receive `editing=true` param. In editing mode:
- Screen shows a back arrow at top (via `onClose` on `OnboardingScreen`, or custom `closeHeader` on custom screens)
- Footer shows a single "Save" button (no Back/Next row)
- `save()` calls `router.back()` instead of advancing to next step
- `setOnboardingStep` is skipped (doesn't reset onboarding progress)
- Layout progress bar is hidden

## Basics Summary (`basics-summary.tsx`)

Summary/edit page showing all basics fields organized by section. Each row shows the current value and navigates to the corresponding screen with `editing=true`. Unanswered fields show a red warning icon + "Answer this" text with highlighted row background.

## Three-State Basics Card (`(tabs)/questions.tsx`)

The Basics card on the Questions screen has three states:
- **Complete** (`basicsComplete`): Green check + "Edit" -> basics-summary
- **Has unanswered** (`completedCategories` includes `"the_basics"` but `basicsComplete` is false): Warning triangle + "Update" -> basics-summary (never forces back into linear onboarding)
- **First time** (never completed onboarding): "Answer" button -> first unanswered step in linear flow

No auto-redirect from questions screen â€” AuthGate handles routing based on completion state.

## Auto-Advance

During initial onboarding, single-question screens (no visibility toggle, no importance slider) with no prior answer auto-advance instantly on selection. Controlled in `BasicOptionScreen` via `canAutoAdvance`.

## Voice Questions Screen (`voice-questions.tsx`)
- Full-screen recording interface for 8 open-ended questions
- States: idle -> recording (waveform) -> preview
- Haptic feedback on start/stop/save/delete
- Auto-saves recordings to Convex storage
- All 8 complete -> auto-triggers `parseVoiceProfile` action (profile parsing only, no compatibility)
- Re-recording any question re-triggers full parsing
- **Celebration screen after Done**: waits for profile to be parsed (disabled button: "Building Your Profile..."), then enables "Review Your Profile" -> navigates to `/profile-audit?firstTime=true`. No `router.back()` fallback.

## Profile Audit Screen (`profile-audit.tsx`)
- Shows the user's AI-generated profile with toggle-able visibility on each field
- **Mandatory mode** (`firstTime=true` or `fromRegenerate=true`): no back button, "Looks Good" button calls `completeProfileAudit` (saves hidden fields + schedules compatibility generation), then navigates to matches (first-time) or back (regeneration)
- **Casual mode** (from Settings > My Profile): back button visible, "Done" button only saves hidden fields
- Hidden fields are stored as dot-paths in `userProfiles.hiddenFields` and stripped before compatibility prompt via `filterProfile()`

## Regenerate Profile (`(tabs)/questions.tsx`)
- "Regenerate Profile" button in sticky footer on Edit Answers screen
- Always visible when voice questions are complete; grayed out unless:
  - User has made a change since last regeneration (`lastProfileEditedAt > lastProfileRegeneratedAt` or new recording `createdAt > lastProfileRegeneratedAt`)
  - Cooldown not active (1 hour between regenerations, `REGENERATE_PROFILE_COOLDOWN_MS`)
- Calls `api.users.regenerateProfile` mutation (rate-limited server-side)
- Shows celebration overlay while parsing; when `myProfile.processedAt` updates, navigates to `/profile-audit?fromRegenerate=true`
- Profile updates (`updateBasics`, `updateProfile`) are NOT rate-limited; only regeneration is
