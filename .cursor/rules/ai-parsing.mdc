---
description: AI profile parsing system with OpenAI integration
globs: convex/actions/parse*, convex/lib/prompts.ts, convex/lib/openai.ts
alwaysApply: false
---

# AI Profile Parsing System

## Architecture Flow
1. User completes onboarding -> `completeOnboarding` mutation runs
2. Mutation schedules `parseUserProfile` action via `ctx.scheduler.runAfter(0, ...)`
3. Action fetches all answers with question details (uses `questionKey` for lookups)
4. Extracts: preferences from checklist pairs (no AI), selected interests (no AI), canonical values from essays (AI), personality traits from scales + AI
5. Results saved to `userProfiles` table

## OpenAI Integration (`convex/lib/openai.ts`)
- Model: `gpt-5-mini-2025-08-07` (~$0.01 per full parse)
- Retry logic with exponential backoff (3 retries)
- JSON response format enforced
- Token usage and cost tracking logged

## Key Prompts (`convex/lib/prompts.ts`)
- `CANONICAL_VALUES_PROMPT`: Maps essays to ~30 canonical values
- `VALUES_INTERESTS_PROMPT`: Legacy raw values/interests extraction (display only)
- `PERSONALITY_TRAITS_PROMPT`: Rates 11 personality dimensions (1-10 scale)
- Bio generation prompts (150-200 word paragraph + one-sentence)
- `EXTRACTION_QUESTION_GROUPS`: Maps extraction types to `questionKey` arrays

## userProfiles Structured Data
- **Matching fields**: `selectedInterests`, `canonicalValues`, `preferences` (12 categories with self/openTo/isDealbreaker)
- **Personality**: 11 traits on 1-10 scale (introversion, adventurousness, ambition, etc.)
- **Relationship style**: loveLanguage, conflictStyle, communicationFrequency, financialApproach, aloneTimeNeed
- **Family**: wantsKids, kidsTimeline, familyCloseness, parentingStyle
- **Lifestyle**: sleepSchedule, exerciseLevel, dietType, alcoholUse, drugUse, petPreference, locationPreference
- **Generated**: generatedBio, shortBio, keywords (15-25), processedAt, openaiModel, confidence
