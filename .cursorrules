# Found - AI Matchmaking Dating App

> **IMPORTANT**: Convex does NOT auto-sync. After ANY change to files in the `convex/` directory, you MUST run `bunx convex dev` (or ensure it's running) to push changes to the dev deployment before testing.

## Project Overview

Found is an AI matchmaking dating app for people serious about finding real partnerships. Users answer 90 deep questions about themselves, and the AI uses these answers to find highly compatible matches. The app emphasizes depth over volume - no swiping, just meaningful connections.

**Current Status**: Beta - Gamified journey system with 6 category levels. Matching features with dealbreakers and preference checklists implemented.

## Tech Stack

- **Framework**: React Native with Expo SDK 54
- **Navigation**: Expo Router (file-based routing)
- **Backend**: Convex (real-time database, no migrations needed)
- **Authentication**: Clerk (phone/SMS auth)
- **AI**: OpenAI API (gpt-5-mini-2025-08-07 for profile parsing)
- **Offline Storage**: MMKV v3 with Zustand persist middleware
- **Language**: TypeScript
- **Package Manager**: Bun

## Project Structure

```
app/                    # Expo Router screens (file-based routing)
├── index.tsx          # Landing page (pre-auth) - introduces Found concept
├── _layout.tsx        # Root layout with AuthGate, font loading, splash screen control
├── (auth)/            # Auth screens
│   ├── _layout.tsx    # Auth stack layout
│   ├── sign-in.tsx    # Phone number input
│   └── verify.tsx     # SMS code verification
├── (onboarding)/      # Onboarding flow
│   ├── _layout.tsx    # Onboarding stack layout
│   ├── basics.tsx     # One-per-page: gender, location, sexuality, birthday, height
│   ├── photos.tsx     # Photo upload (6 slots, 2 required) → completes Level 1
│   └── questions.tsx  # Category-based questions with progress (modal presentation)
├── (tabs)/            # Main tab navigation (post-onboarding)
│   ├── _layout.tsx    # Tab bar layout
│   ├── index.tsx      # Home screen
│   ├── journey.tsx    # Journey/Level progression screen
│   └── matches.tsx    # Matches screen
└── profile.tsx        # Profile page (modal)

convex/                # Convex backend
├── schema.ts          # Database schema (users, photos, questions, answers, userProfiles)
├── users.ts           # User mutations/queries + onboarding completion
├── photos.ts          # Photo upload/management
├── questions.ts       # Question queries
├── seedQuestions.ts   # 90 questions seed data + seed mutation
├── answers.ts         # User answer storage + internal query for AI parsing
├── userProfiles.ts    # Structured profile data queries/mutations
├── matching.ts        # Legacy compatibility scoring
├── storage.ts         # File storage URL generation
├── lib/
│   ├── openai.ts      # OpenAI client wrapper with retry logic
│   ├── prompts.ts     # AI extraction prompt templates
│   ├── interests.ts   # Interest library (1000+ items by category)
│   └── canonicalValues.ts # Canonical values for AI extraction (~30 items)
└── actions/
    └── parseProfile.ts # Background action to parse answers into structured data

components/            # Reusable components
├── AppHeader.tsx      # Shared header: Lvl X/6 | Found | Avatar (used on all tabs)
├── JourneyPath.tsx    # Category progression UI with animated completion/unlock
├── ProgressBar.tsx    # Simple progress bar for questions
├── QuestionCard.tsx   # Renders question types (multiple_choice, text, essay, scale, checklist, interest_picker)
├── InterestPicker.tsx # Autocomplete interest selection from library
├── AvatarPicker.tsx   # Avatar display + upload with cropping
└── OfflineBanner.tsx  # Shows when device is offline

lib/                   # Utilities
├── theme.ts           # Light theme colors + typography (fonts, fontSizes, spacing, colors)
├── categories.ts      # 6 question categories with levels, question ranges, unlock descriptions
├── matching.ts        # NEW: 6-category compatibility scoring algorithm
├── onboarding-flow.ts # Configurable onboarding step order for A/B testing
├── ai-import.ts       # AI prompt generation and JSON response parsing
├── clerk.tsx          # Clerk auth provider
├── convex.tsx         # Convex client provider
├── media.ts           # Image picker utilities
├── avatar.ts          # Avatar upload helpers
├── token-cache.ts     # Clerk token caching
└── offline-auth.ts    # Cached auth state

hooks/                 # Custom React hooks
├── useOfflineSync.ts  # Network detection
├── usePushNotifications.ts # Push notification setup
└── useScreenReady.ts  # Splash screen control + fade-in animation for first screen

stores/                # Zustand stores
└── offline.ts         # Offline state + user caching
```

## Key Conventions

### Styling

- **Light theme only** - Clean, elegant aesthetic
- Inline StyleSheet.create() at bottom of each file
- Import colors, fonts, fontSizes, spacing from `@/lib/theme`
- Typography: System sans-serif for body, Cormorant (serif) for headings
- Color palette (from `lib/theme.ts`):
  - Background: `#FAFAFA`
  - Surface: `#FFFFFF`
  - Text: `#1A1A1A`
  - Text secondary: `#666666`
  - Text muted: `#999999`
  - Primary (buttons): `#000000`
  - Border: `#E5E5E5`
  - Success: `#22c55e`
  - Error: `#ef4444`

### Fonts

- Body text: System font (clean sans-serif)
- Headings: `Cormorant_500Medium`, `Cormorant_700Bold`, `Cormorant_500Medium_Italic`
- Loaded via `@expo-google-fonts/cormorant` in `app/_layout.tsx`
- Access via `fonts.serif`, `fonts.serifBold`, `fonts.serifItalic` from theme

### Navigation

- Use `router.replace()` for auth redirects and when navigation history may be empty
- Use `router.push()` for normal navigation within a flow
- Use `router.back()` only when certain there's navigation history
- Auth flow handled in `app/_layout.tsx` via AuthGate component
- Onboarding uses `router.replace()` for back navigation to avoid errors when history is empty
- Onboarding step saved to database (`onboardingStep` field) for resume on app restart

### Data Fetching (Convex)

- Use `useQuery()` for reading data - automatically real-time
- Use `useMutation()` for writes
- Pass `"skip"` as second argument to conditionally skip queries:
  ```typescript
  const data = useQuery(
    api.users.current,
    userId ? { clerkId: userId } : "skip"
  );
  ```

### Question Types

The app supports 6 question types (defined in `components/QuestionCard.tsx`):
- `multiple_choice`: Radio button selection from options array
- `text`: Single-line text input
- `essay`: Multi-line textarea for longer responses
- `scale`: Slider from min to max with optional labels
- `checklist`: Multi-select with "Open to any" option + optional dealbreaker toggle
- `interest_picker`: Autocomplete selection from 1000+ item interest library

### Checklist Questions with Dealbreakers

Checklist questions come in pairs (e.g., Q1 + Q2):
- Q1: "What are you looking for?" (multiple_choice) - User's own answer
- Q2: "What are you open to in a partner?" (checklist) - Partner preferences

Checklist behavior:
- "Open to any" checks all options and hides dealbreaker toggle
- Specific selections show dealbreaker toggle
- Unchecking "Open to any" clears all selections
- Selecting all options auto-checks "Open to any"

### Photo Upload

- 6-slot grid layout, first 2 required
- Uses `react-native-image-crop-picker` for cropping (native) or `expo-image-picker` (web fallback)
- Upload flow: pick → crop → upload to Convex storage → save to photos table
- Photos stored with `order` field (0-5) for display order

---

## Database Schema (Convex)

### users
- `clerkId`: string (indexed by `by_clerk_id`)
- `phone`: string (indexed by `by_phone`)
- `name`: string (optional)
- `avatarUrl`: string (optional)
- `gender`: string (optional) - "Man", "Woman", "Non-binary"
- `location`: string (optional) - Auto-detected city/state
- `sexuality`: string (optional) - "Men", "Women", "Everyone"
- `birthdate`: string (optional, ISO date)
- `heightInches`: number (optional)
- `onboardingComplete`: boolean (optional)
- `onboardingStep`: string (optional) - Current step for resume: "basics", "photos"
- `level`: number (optional) - 1-6, derived from completed categories
- `completedCategories`: string[] (optional) - ["the_basics", "who_you_are", ...]
- `waitlistPosition`: number (optional)
- `pushToken`: string (optional)
- `notificationsEnabled`: boolean (optional)
- `reminderHour`: number (optional)
- `reminderMinute`: number (optional)

### photos
- `userId`: Id<"users">
- `storageId`: Id<"_storage">
- `url`: string
- `order`: number (0-5)
- Index: `by_user`

### questions
- `order`: number (1-91) - Display sequence only
- `questionKey`: string - Stable identifier (e.g., "relationship_goals_self") for referencing questions in code
- `text`: string
- `type`: "multiple_choice" | "text" | "essay" | "scale" | "range" | "checklist" | "interest_picker"
- `options`: string[] (optional, for multiple_choice and checklist)
- `category`: string (optional) - 6 categories total
- `scaleMin`, `scaleMax`: number (optional, for scale and range)
- `scaleMinLabel`, `scaleMaxLabel`: string (optional)
- `linkedQuestionKey`: string (optional) - For checklist type, links to source question by key
- `hasDealbreaker`: boolean (optional) - Whether this question can have a dealbreaker toggle
- Indexes: `by_order`, `by_key`

**Important**: Always use `questionKey` (not `order`) when referencing specific questions in code. This allows inserting new questions without breaking existing logic.

### answers
- `userId`: Id<"users">
- `questionId`: Id<"questions">
- `value`: string - JSON string for complex answers (checklist = JSON array), plain string for simple
- `source`: "ai" | "manual" (optional) - Tracks whether answer came from AI import or manual entry
- `isDealbreaker`: boolean (optional) - Whether user marked this preference as a dealbreaker
- Indexes: `by_user`, `by_user_question`

### userProfiles (AI-extracted structured data)
- `userId`: Id<"users"> (indexed by `by_user`)

**NEW: Matching-specific fields:**
- `selectedInterests`: string[] (optional) - Interest IDs from picker (used for matching)
- `canonicalValues`: string[] (optional) - AI-extracted values from ~30 item canonical list
- `preferences`: object (optional) - Structured preferences from checklist pairs:
  - `relationshipGoals`, `relationshipStyle`, `hasChildren`, `wantsChildren`, `ethnicity`, `religion`, `politics`, `education`, `alcohol`, `smoking`, `marijuana`, `drugs`
  - Each contains: `{ self: string, openTo: string[], isDealbreaker: boolean }`

**Legacy display fields (not used for matching):**
- `values`: string[] - Raw values from essays
- `interests`: string[] - Raw interests from essays
- `dealbreakers`: string[] - Non-negotiables

**Personality traits (11 dimensions, 1-10 scale):**
- `traits.introversion`, `adventurousness`, `ambition`, `emotionalOpenness`, `traditionalValues`, `independenceNeed`, `romanticStyle`, `socialEnergy`, `communicationStyle`, `attachmentStyle`, `planningStyle`

**Relationship style:**
- `relationshipStyle.loveLanguage`, `conflictStyle`, `communicationFrequency`, `financialApproach`, `aloneTimeNeed`

**Family plans:**
- `familyPlans.wantsKids`, `kidsTimeline`, `familyCloseness`, `parentingStyle`

**Lifestyle:**
- `lifestyle.sleepSchedule`, `exerciseLevel`, `dietType`, `alcoholUse`, `drugUse`, `petPreference`, `locationPreference`

**Optional narrative sections:**
- `lifeStory`, `socialProfile`, `intimacyProfile`, `lovePhilosophy`, `partnerPreferences`, `bioElements`, `demographics`, `health`

**Generated content:**
- `generatedBio`: string (optional) - Full paragraph bio (150-200 words)
- `shortBio`: string (optional) - One-sentence bio for match cards
- `keywords`: string[] - Searchable keywords (15-25)
- `processedAt`: number (timestamp)
- `openaiModel`: string
- `confidence`: number (0-1)

---

## Question Categories (6 total, 90 questions)

| Level | Category | Questions | What it Scores |
|-------|----------|-----------|----------------|
| 1 | **The Basics** | Q1-33 | Preference checklists + dealbreakers (goals, kids, ethnicity, religion, politics, substances) |
| 2 | **Who You Are** | Q34-46 | Personality scales + canonical values from essays |
| 3 | **Relationship Style** | Q47-60 | Communication, attachment, intimacy, finances |
| 4 | **Lifestyle** | Q61-72 | Sleep schedule, exercise, social life, health |
| 5 | **Life & Future** | Q73-82 | Family closeness, location flexibility, career ambitions |
| 6 | **The Deeper Stuff** | Q83-91 | Shared interests (from picker, rarity-weighted) + philosophy |

---

## Compatibility Scoring Algorithm (`lib/matching.ts`)

### 6 Category Scores (aligned with question categories)

| Category | Weight | Data Sources |
|----------|--------|--------------|
| **The Basics** | 25% | Checklist preferences + dealbreakers |
| **Who You Are** | 20% | Personality traits + canonical values |
| **Relationship Style** | 20% | Love language, conflict, communication, finances |
| **Lifestyle** | 15% | Sleep, exercise, social, substances |
| **Life & Future** | 10% | Family closeness, kids, religion/politics (weighted by importance) |
| **The Deeper Stuff** | 10% | Shared interests (rarity-weighted) + philosophy |

### Dealbreaker System

Dealbreakers are extracted from checklist preferences:
- If user selects specific options (not "Open to any") and marks as dealbreaker
- Bidirectional check: both users' dealbreakers matter
- Triggered dealbreakers can filter out matches or show warnings

### Interest Matching (Rarity-Weighted)

```typescript
// Niche shared interests count more than common ones
function scoreTheDeeperStuff(p1, p2) {
  const shared = p1.selectedInterests.filter(i => p2.selectedInterests.includes(i));
  // Rarer interests (specific movies, artists) = higher weight
  // Common interests (genres like "Rock") = lower weight
}
```

### Canonical Values Library (`convex/lib/canonicalValues.ts`)

~30 core values for reliable AI extraction:
```
honesty, loyalty, family, growth, adventure, independence, security, creativity,
ambition, kindness, humor, faith, authenticity, empathy, respect, integrity,
balance, passion, curiosity, optimism, resilience, patience, generosity,
compassion, courage, wisdom, freedom, tradition, equality, justice
```

### Interest Library (`convex/lib/interests.ts`)

1000+ interests organized by category:
- Movies & TV (genres, franchises, shows, directors)
- Music (genres, artists, activities)
- Books & Reading (genres, authors, series)
- Gaming (types, genres, games, platforms)
- Sports & Fitness (watching, playing, fitness)
- Outdoors & Nature
- Food & Drink
- Travel
- Arts & Creativity
- Technology
- Lifestyle
- Animals & Pets
- Learning & Education
- Entertainment
- Collecting & Hobbies
- Social Causes

---

## AI Profile Parsing System

### Overview
After a user completes all 90 questions, a background Convex action parses their answers using OpenAI to extract structured data for efficient compatibility matching.

### Architecture Flow
1. User completes onboarding → `completeOnboarding` mutation runs
2. Mutation schedules `parseUserProfile` action via `ctx.scheduler.runAfter(0, ...)`
3. Action fetches all answers with question details
4. Action extracts:
   - **Preferences** from checklist question pairs (no AI needed)
   - **Selected interests** from interest picker (no AI needed)
   - **Canonical values** from essays (AI maps to ~30 item list)
   - **Personality traits** from scale questions + AI analysis
5. Results saved to `userProfiles` table

### OpenAI Integration (`convex/lib/openai.ts`)
- Default model: `gpt-5-mini-2025-08-07` (~$0.01 per user full parse)
- Retry logic with exponential backoff (3 retries)
- JSON response format enforced
- Token usage and cost tracking logged to console

### Key Prompts (`convex/lib/prompts.ts`)
- `CANONICAL_VALUES_PROMPT`: Extracts only values from the canonical ~30 item list
- `VALUES_INTERESTS_PROMPT`: Legacy extraction for raw values/interests (display only)
- `PERSONALITY_TRAITS_PROMPT`: Rates 11 personality dimensions on 1-10 scale
- Bio generation prompts for paragraph and one-sentence bios

---

## Onboarding Flow Details

### Basics Screen (`app/(onboarding)/basics.tsx`)
- **One question per page** with back/next navigation
- **Step 1 - Gender**: "Man", "Woman", "Non-binary" options
- **Step 2 - Interested In**: "Men", "Women", "Everyone" options
- **Step 3 - Location**: "Enable Location" button using `expo-location`, auto-detects city/state
- **Step 4 - Birthday**: `@react-native-community/datetimepicker`, shows calculated age, 18+ note
- **Step 5 - Height**: Slider in feet/inches format

### Photos Screen (`app/(onboarding)/photos.tsx`)
- 6-slot grid, first 2 marked "Required"
- Uses `react-native-image-crop-picker` with 1:1 aspect ratio
- On continue: calls `completeCategory("the_basics")` and navigates to Journey tab

### Questions Screen (`app/(onboarding)/questions.tsx`)
- Opens as modal from Journey screen with `categoryId` param
- Shows category name centered with X button to close
- Progress bar + "X/Y" count for current category only
- One question per page, auto-saves answers on change
- Supports all 6 question types including checklist and interest_picker
- Dealbreaker toggle shows for checklist questions with specific selections
- Completing last question triggers `completeCategory` mutation
- Navigates back to Journey with `completed` param to trigger animation

---

## Environment Variables

### Local (.env.local)
```
EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_xxx
EXPO_PUBLIC_CONVEX_URL=https://xxx.convex.cloud
```

### Convex Environment (set via `bunx convex env set`)
```
OPENAI_API_KEY=sk-xxx
```

---

## Running the App

```bash
# Install dependencies
bun install

# Set OpenAI API key in Convex
bunx convex env set OPENAI_API_KEY sk-your-key-here

# Start Convex dev server (keep running in separate terminal)
bunx convex dev

# Seed questions (run once)
bunx convex run seedQuestions:seedQuestions

# Start Expo
bun start

# Press 'i' for iOS simulator
```

---

## Important Notes

- **Development build required** for native modules (image picker, slider)
- iOS-first but works on Android
- Convex handles all real-time sync automatically
- Questions must be seeded before onboarding works
- OpenAI API key must be set in Convex environment for profile parsing
- Profile parsing runs automatically after onboarding completion
- **Splash screen control**: Stays visible until routing is determined and first screen data is loaded
- **Screen transitions**: First screen fades in smoothly using `useScreenReady` hook
- **Onboarding resume**: Uses `onboardingStep` field in database to resume at correct step on app restart

---

## Implemented Features

### Journey/Level System (IMPLEMENTED)

**Purpose**: Gamify the 90 questions by breaking them into 6 categories. Users progress through levels by completing categories, with each level unlocking a new compatibility score.

**User Flow**:
1. After photos, user completes Level 1 (The Basics) and enters the Journey
2. Journey screen shows linear path of 6 categories with icons
3. Categories must be completed in order
4. Tapping a category opens the questions modal
5. Completing all questions in a category triggers completion animation
6. Animation shows: collapse → turn green + checkmark → next category unlocks
7. Each level unlocks that category's compatibility score with matches

**Category Progression** (`lib/categories.ts`):
| Level | Category | Questions | Unlock |
|-------|----------|-----------|--------|
| 1 | The Basics | Q1-33 | Essential compatibility filters |
| 2 | Who You Are | Q34-46 | Personality compatibility score |
| 3 | Relationship Style | Q47-60 | Relationship compatibility score |
| 4 | Lifestyle | Q61-72 | Lifestyle compatibility score |
| 5 | Life & Future | Q73-82 | Life goals compatibility score |
| 6 | The Deeper Stuff | Q83-91 | Full profile & max visibility |

**UI Components**:
- `AppHeader`: Shows "Lvl X/6" on left, "Found" center, avatar right
- `JourneyPath`: Scrollable list of category nodes with state-based styling

**Convex Mutations**:
- `completeCategory`: Adds category to completedCategories, increments level
- `uncompleteCategory`: Removes category (for testing)
- `resetJourney`: Clears all progress (DEV only)

---

### Dealbreaker & Preference System (IMPLEMENTED)

**Purpose**: Allow users to specify both what they are and what they're open to in a partner, with optional dealbreaker flags.

**Question Structure**:
Each preference area has a pair of questions:
1. Self-description (multiple_choice): "Do you have kids?"
2. Partner preference (checklist): "Are you open to partners who have kids?"

**Checklist Features**:
- "Open to any" option that auto-selects all
- Dealbreaker toggle appears when specific options selected
- Stored in `answers` table with `isDealbreaker` flag
- Extracted to `userProfiles.preferences` for matching

**Categories with Preferences**:
- Relationship Goals (Q1-2)
- Relationship Style (Q3-4)
- Has Children (Q5-6)
- Wants Children (Q7-8)
- Ethnicity (Q14-15)
- Religion (Q16-17)
- Politics (Q19-20)
- Education (Q22-23)
- Alcohol (Q25-26)
- Smoking (Q27-28)
- Marijuana (Q29-30)
- Drugs (Q31-32)

---

### Interest Picker (IMPLEMENTED)

**Purpose**: Let users select interests from a large curated library for better matching on niche shared interests.

**Features**:
- 1000+ interests organized by 16 categories
- Autocomplete search as you type
- Category tabs for browsing
- Selected interests shown as removable tags
- Soft limit of 25 selections
- Rarity-weighted matching (niche interests count more)

**Question**: Q90 "What are your interests?" with type `interest_picker`

---

### Canonical Values System (IMPLEMENTED)

**Purpose**: Extract values from essays that match a canonical list for reliable matching.

**How it works**:
- AI extracts only from ~30 predefined values
- Maps arbitrary essay text to closest canonical value
- Non-matching values stored as `rawValues` (for display only)
- `canonicalValues` used for Jaccard similarity matching

---

## Coming Soon Features

These features are planned but not yet implemented.

### AI Matchmaker Chat Interface
- Chat UI for match presentation
- AI presents ONE match at a time with compatibility breakdown
- "Ask more questions" feature to dig deeper before deciding

### Double Opt-In & Automated Date Booking
- Mutual match system (User A likes B, B likes A = match)
- AI handles date scheduling and restaurant booking via Resi API
- Chat opens 2 hours before date (logistics only)
