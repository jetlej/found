---
description: AI profile parsing system with OpenAI integration
globs: convex/actions/parse*, convex/lib/prompts.ts, convex/lib/openai.ts
alwaysApply: false
---

# AI Profile Parsing System

## Architecture Flow (Voice-First)

1. User records 8 voice answers -> `saveRecording` mutation triggers `parseVoiceProfile` when count reaches 8
2. Action transcribes audio with Whisper (parallel, reuses existing transcriptions)
3. Single GPT call extracts all structured data from combined transcripts
4. Results saved to `userProfiles` table

## OpenAI Integration (`convex/lib/openai.ts`)

- Model: `gpt-5-mini-2025-08-07` (~$0.03 per profile extraction)
- Retry logic with exponential backoff (3 retries)
- JSON response format enforced
- Token usage and cost tracking logged

## Voice Extraction Prompt (`convex/actions/parseVoiceProfile.ts`)

Single comprehensive prompt extracts all fields from 8 voice transcripts. Only fields well-supported by the questions are displayed in the UI.

## userProfiles Structured Data

- **Core**: `canonicalValues[]`, `values[]`, `interests[]`, `dealbreakers[]`, `keywords[]`
- **Personality**: 11 traits on 1-10 scale (introversion, adventurousness, ambition, emotionalOpenness, traditionalValues, independenceNeed, romanticStyle, socialEnergy, communicationStyle, attachmentStyle, planningStyle)
- **Relationship style**: loveLanguage (Q1), conflictStyle, aloneTimeNeed (Q1) — displayed; communicationFrequency, financialApproach — extracted but not displayed (weak question support)
- **Family**: familyCloseness (Q4), kidsTimeline (Q4 conditional) — displayed; wantsKids, parentingStyle — extracted but not displayed
- **Life story**: proudestAchievement, definingHardship, biggestRisk, dreams, fears (Q2+Q7)
- **Love philosophy**: loveDefinition, healthyRelationshipVision (Q1 conditional)
- **Partner preferences**: mustHaves, niceToHaves, redFlags, dealbreakersInPartner (Q5)
- **Bio elements**: conversationStarters, uniqueQuirks, passions (Q6+Q8)
- **Extracted but NOT displayed** (weak/no question support): socialProfile, intimacyProfile (except connectionTriggers), lifestyle, health, demographics
- **Generated**: generatedBio, shortBio, processedAt, openaiModel, confidence
- **Utility**: `formatLabel()` converts snake_case enum values to Title Case for display

## AI Compatibility Analysis (separate from profile parsing)

- **Action**: `convex/actions/analyzeCompatibility.ts` — per-pair GPT call comparing two parsed profiles
- **Storage**: `compatibilityAnalyses` table (see `convex/compatibilityAnalyses.ts` for queries/mutations)
- **Output**: summary, green/yellow/red flags, 10 category scores (0-10), overall score (0-100 with dealbreaker penalty)
- This is a **separate system** from profile parsing — profile parsing extracts data from voice transcripts, compatibility analysis compares two already-parsed profiles
