---
description: Convex backend patterns and conventions
globs: convex/**
alwaysApply: false
---

# Convex Backend Conventions

## Data Fetching (used in app/ files that import from convex)

- `useQuery()` for reads (automatically real-time)
- `useMutation()` for writes
- Pass `"skip"` to conditionally skip queries:
  ```typescript
  const data = useQuery(api.users.current, userId ? {} : "skip");
  ```
- Auth is server-side: `ctx.auth.getUserIdentity()` provides the Clerk identity. Do NOT pass `clerkId` as a function argument.

## Background Actions

- Schedule with `ctx.scheduler.runAfter(0, internal.actions.myAction, { args })`
- Actions can call external APIs (OpenAI, etc.)
- Use `internalAction` / `internalMutation` for non-client-callable functions

## Environment Variables

- Set via `bunx convex env set KEY value`
- Access via `process.env.KEY` in actions
- `OPENAI_API_KEY` must be set for profile parsing

## Seeding Test Users

All seeding uses the **voice pipeline** (`convex/actions/seedVoiceTestUsers.ts`). Each seeded user goes through: generate basics + voice answers (parallel GPT) → create user with full demographics → save recordings → schedule `parseVoiceProfile` (which triggers compatibility analysis). Profile parsing runs as a separate scheduled action to avoid timeouts.

```bash
bunx convex run seedQuestions:seedQuestions                                    # Seed questions (run once)
bunx convex run actions/seedVoiceTestUsers:seedCelebProfiles                  # 10 celebrity personas
bunx convex run actions/seedVoiceTestUsers:seedHighCompatUsers                # 3 high-compat personas
bunx convex run actions/seedVoiceTestUsers:seedVoiceProfilesForTestUsers      # 10 random GPT personas
bunx convex run actions/seedTestPhotos:seedCelebPhotos                        # Photos for celebs (separate, Wikimedia)
bunx convex run actions/seedTestPhotos:seedTestPhotos                         # Photos for named test users (separate)
bunx convex run seedTestUsers:deleteAllBots                                   # Wipe all bot users + related data
bunx convex run actions/seedVoiceTestUsers:backfillTestUserBasics             # Backfill basics on old users only
```

- `convex/actions/seedTestUsers.ts` is **LEGACY** (written-answer path) — do not use for new seeding.
- Persona definitions: celebrities + high-compat in `seedVoiceTestUsers.ts`, photo URLs in `seedTestPhotos.ts` (keyed by name, not ID).
- `createTestUser` accepts optional basics args; when provided, user is created with real demographics instead of placeholders.

## Config Table

Key-value store in `config` table for app-wide settings (e.g., `minBuildNumber` for force updates). Query by key index.
